ifelse(
str_detect(team, home_team), "home_goalie", NA
)
)
)
rg %>%
filter(event == "Goalie") %>%
# filter(str_detect(description, "Starting|Returned"))
dplyr::select(home_team, away_team, team, description,
first_player, event, sec_from_start) %>%
mutate(
goalie_change = str_extract(description, "Starting|Returned|Pulled"),
goalie = ifelse(
str_detect(team, away_team), "away_goalie",
ifelse(
str_detect(team, home_team), "home_goalie", NA
)
)
)
rg %>%
filter(event == "Goalie") %>%
# filter(str_detect(description, "Starting|Returned"))
dplyr::select(home_team, away_team, team, description,
first_player, event, sec_from_start) %>%
mutate(
goalie_change = str_extract(description, "Starting|Returned|Pulled"),
goalie = ifelse(
str_detect(team, away_team), "away_goalie",
ifelse(
str_detect(team, home_team), "home_goalie", NA
)
)
) %>%
dplyr::select(first_player, sec_from_start, goalie_change, goalie)
rg %>%
filter(event == "Goalie") %>%
# filter(str_detect(description, "Starting|Returned"))
dplyr::select(home_team, away_team, team, description,
first_player, event, sec_from_start) %>%
mutate(
goalie_change = str_extract(description, "Starting|Returned|Pulled"),
goalie = ifelse(
str_detect(team, away_team), "away_goalie",
ifelse(
str_detect(team, home_team), "home_goalie", NA
)
),
first_player = ifelse(goalie_change == "Pulled", "None")
) %>%
dplyr::select(first_player, sec_from_start, goalie_change, goalie)
rg %>%
filter(event == "Goalie") %>%
# filter(str_detect(description, "Starting|Returned"))
dplyr::select(home_team, away_team, team, description,
first_player, event, sec_from_start) %>%
mutate(
goalie_change = str_extract(description, "Starting|Returned|Pulled"),
goalie = ifelse(
str_detect(team, away_team), "away_goalie",
ifelse(
str_detect(team, home_team), "home_goalie", NA
)
),
first_player = ifelse(goalie_change == "Pulled", "None", first_player)
) %>%
dplyr::select(first_player, sec_from_start, goalie_change, goalie)
rg %>%
filter(event == "Goalie") %>%
# filter(str_detect(description, "Starting|Returned"))
dplyr::select(home_team, away_team, team, description,
first_player, event, sec_from_start) %>%
mutate(
goalie_change = str_extract(description, "Starting|Returned|Pulled"),
goalie = ifelse(
str_detect(team, away_team), "away_goalie",
ifelse(
str_detect(team, home_team), "home_goalie", NA
)
),
first_player = ifelse(goalie_change == "Pulled", "None", first_player)
) %>%
dplyr::select(first_player, sec_from_start, goalie_change, goalie) %>%
pivot_wider(names_from = goalie,
values_from = first_player)
gl <- rg %>%
filter(event == "Goalie") %>%
# filter(str_detect(description, "Starting|Returned"))
dplyr::select(home_team, away_team, team, description,
first_player, event, sec_from_start) %>%
mutate(
goalie_change = str_extract(description, "Starting|Returned|Pulled"),
goalie = ifelse(
str_detect(team, away_team), "away_goalie",
ifelse(
str_detect(team, home_team), "home_goalie", NA
)
),
first_player = ifelse(goalie_change == "Pulled", "None", first_player)
) %>%
dplyr::select(first_player, sec_from_start, goalie_change, goalie) %>%
pivot_wider(names_from = goalie,
values_from = first_player)
head(gl)
rg <- rg %>%
right_join(gl, by = c("sec_from_start"))
view(rg)
rg <- load_pbp(game_id = 268078)
rg <- rg %>%
left_join(tm, by = character())
rg <- rg %>%
left_join(gl, by = c("sec_from_start"))
view(rg)
rg <- rg %>%
fill(home_goalie) %>%
fill(away_goalie)
view(rg)
rg <- rg %>%
fill(home_goalie) %>%
fill(away_goalie) %>%
dplyr::filter(event != "Goalie") %>%
mutate(
home_goalie = ifelse(home_goalie == "None", NA, home_goalie),
away_goalie = ifelse(away_goalie == "None", NA, away_goalie)
)
view(rg)
table(rg$event)
rg <- rg %>%
fill(home_goalie) %>%
fill(away_goalie) %>%
dplyr::filter(event != "Goalie") %>%
mutate(
home_goalie = ifelse(home_goalie == "None", NA, home_goalie),
away_goalie = ifelse(away_goalie == "None", NA, away_goalie),
goalie_involved = ifelse(event %in% c("Goal", "PP Goal", "Shot", "Shot BLK") &
str_detect(team, home_team), away_goalie,
ifelse(event %in% c("Goal", "PP Goal", "Shot", "Shot BLK") &
str_detect(team, home_team), home_goalie, NA
)
)
)
view(rg)
rg <- rg %>%
fill(home_goalie) %>%
fill(away_goalie) %>%
dplyr::filter(event != "Goalie") %>%
mutate(
home_goalie = ifelse(home_goalie == "None", NA, home_goalie),
away_goalie = ifelse(away_goalie == "None", NA, away_goalie),
goalie_involved = ifelse(event %in% c("Goal", "PP Goal", "Shot", "Shot BLK") &
str_detect(team, home_team), away_goalie,
ifelse(event %in% c("Goal", "PP Goal", "Shot", "Shot BLK") &
str_detect(team, away_team), home_goalie, NA
)
)
)
view(rg)
colnames(rg)
r <- rg %>%
dplyr::select(game_id, home_team, away_team, period_id, event_no, description, clock, on_ice_situation,
home_goals, away_goals, leader, team, event,
first_player, first_number, second_player, second_number, third_player, third_number,
shot_type, shot_result, goalie_involved,
penalty, penalty_length, penalty_type, penalty_called,
offensive_player_one, offensive_player_two, offensive_player_three,
offensive_player_four, offensive_player_five,
home_goalie, away_goalie, goalie_change)
view(r)
raw[[1]]
rg$time
rg$clock
source('R/pbp_functions.R')
rg <- load_pbp(game_id = 268078)
rg$clock
source('R/pbp_functions.R')
rg <- load_pbp(game_id = 268078)
rg$clock
source('R/pbp_functions.R')
rg <- load_pbp(game_id = 268078)
rg$clock
tm <- raw[[max(length(raw)) - 1]] %>%
clean_names() %>%
mutate(
order = row_number(),
meta = ifelse(
order == 1, "away_team", ifelse(
order == 2, "home_team", NA
)
)
) %>%
dplyr::select(shots, meta) %>%
pivot_wider(values_from = shots,
names_from = meta)
rg <- rg %>%
left_join(tm, by = character())
gl <- rg %>%
filter(event == "Goalie") %>%
# filter(str_detect(description, "Starting|Returned"))
dplyr::select(home_team, away_team, team, description,
first_player, event, sec_from_start) %>%
mutate(
goalie_change = str_extract(description, "Starting|Returned|Pulled"),
goalie = ifelse(
str_detect(team, away_team), "away_goalie",
ifelse(
str_detect(team, home_team), "home_goalie", NA
)
),
first_player = ifelse(goalie_change == "Pulled", "None", first_player)
) %>%
dplyr::select(first_player, sec_from_start, goalie_change, goalie) %>%
pivot_wider(names_from = goalie,
values_from = first_player)
rg <- rg %>%
left_join(gl, by = c("sec_from_start"))
rg <- rg %>%
fill(home_goalie) %>%
fill(away_goalie) %>%
dplyr::filter(event != "Goalie") %>%
mutate(
home_goalie = ifelse(home_goalie == "None", NA, home_goalie),
away_goalie = ifelse(away_goalie == "None", NA, away_goalie),
goalie_involved = ifelse(event %in% c("Goal", "PP Goal", "Shot", "Shot BLK") &
str_detect(team, home_team), away_goalie,
ifelse(event %in% c("Goal", "PP Goal", "Shot", "Shot BLK") &
str_detect(team, away_team), home_goalie, NA
)
),
time_elapsed = time,
time_remaining = clock
)
view(rg)
r <- rg %>%
dplyr::select(game_id, home_team, away_team, period_id, event_no, description, time_remaining, on_ice_situation,
home_goals, away_goals, leader, team, event,
first_player, first_number, second_player, second_number, third_player, third_number,
shot_type, shot_result, goalie_involved,
penalty, penalty_length, penalty_type, penalty_called,
offensive_player_one, offensive_player_two, offensive_player_three,
offensive_player_four, offensive_player_five,
home_goalie, away_goalie, goalie_change)
view(r)
gl
rg <- load_pbp(game_id = 268078)
rg <- rg %>%
left_join(tm, by = character())
gl <- rg %>%
filter(event == "Goalie") %>%
# filter(str_detect(description, "Starting|Returned"))
dplyr::select(home_team, away_team, team, description,
first_player, event, sec_from_start) %>%
mutate(
goalie_change = str_extract(description, "Starting|Returned|Pulled"),
goalie = ifelse(
str_detect(team, away_team), "away_goalie",
ifelse(
str_detect(team, home_team), "home_goalie", NA
)
),
first_player = ifelse(goalie_change == "Pulled", "None", first_player)
) %>%
dplyr::select(first_player, sec_from_start, goalie_change, goalie) %>%
pivot_wider(names_from = goalie,
values_from = first_player)
g <- rg %>%
left_join(gl, by = c("sec_from_start"))
View(g)
rg <- rg %>%
left_join(gl, by = c("sec_from_start"))
rg <- rg %>%
fill(home_goalie) %>%
fill(away_goalie) %>%
dplyr::filter(event != "Goalie") %>%
mutate(
home_goalie = ifelse(home_goalie == "None", NA, home_goalie),
away_goalie = ifelse(away_goalie == "None", NA, away_goalie),
goalie_involved = ifelse(event %in% c("Goal", "PP Goal", "Shot", "Shot BLK") &
str_detect(team, home_team), away_goalie,
ifelse(event %in% c("Goal", "PP Goal", "Shot", "Shot BLK") &
str_detect(team, away_team), home_goalie, NA
)
),
time_elapsed = time,
time_remaining = clock
)
source('R/pbp_functions.R')
a <- Sys.time()
rg <- load_pbp(game_id = 268078)
Sys.time() - a
source('R/pbp_functions.R')
a <- Sys.time()
rg <- load_pbp(game_id = 268078, type = "clean")
Sys.time() - a
a <- Sys.time()
rg <- load_pbp(game_id = 268078)
Sys.time() - a
source('R/pbp_functions.R')
a <- Sys.time()
rg <- load_pbp(game_id = 268078)
Sys.time() - a
source('R/pbp_functions.R')
a <- Sys.time()
rg <- load_pbp(game_id = 268078)
Sys.time() - a
head(rg, 1)
View(rg)
View(r)
setdiff(colnames(rg), colnames(r))
setdiff(colnames(r), colnames(rg))
rm(list = ls())
source('R/pbp_functions.R')
a <- Sys.time()
rg <- load_pbp(game_id = 268078)
rg_messy <- load_pbp(game_id = 268078, format = "messy")
Sys.time() - a
view(rg)
rm(list = ls())
source('R/pbp_functions.R')
a <- Sys.time()
rg <- load_pbp(game_id = 268078)
rg_messy <- load_pbp(game_id = 268078, format = "messy")
Sys.time() - a
a <- Sys.time()
rg <- load_pbp(game_id = 268078)
rg_messy <- load_pbp(game_id = 268078, format = "messy")
Sys.time() - a
ot <- load_pbp(game_id = 268116)
ot2 <- load_pbp(game_id = 268116, format = "messy")
so <- load_pbp(game_id = 268123)
so2 <- load_pbp(game_id = 268123, format = "m")
Sys.time() - a
write.csv(rg, file = "clean_data.csv", row.names = FALSE)
write.csv(rg_messy, file = "messy_data.csv", row.names = FALSE)
View(so2)
View(so2)
View(so2)
View(so)
gc()
data <- load_raw_data(game_id = 268123)
source('R/pbp_functions.R')
data <- load_raw_data(game_id = 268123)
data
score <- data[[max(length(data)) - 2]]
shot <- data[[max(length(data)) - 1]]
df <- data[[max(length(data))]]
score <- data[[max(length(data)) - 2]]
shot <- data[[max(length(data)) - 1]]
score
shot
score <- score %>%
clean_names() #%>%
score
ncol(score)
shot
shot <- shot %>%
clean_names() %>%
rename("team" = "shots",
"first_shots" = "x1st",
"second_shots" = "x2nd",
"third_shots" = "x3rd",
"overtime_shots" = :ot,
"total_shots" = "t")
shot <- shot %>%
clean_names() %>%
rename("team" = "shots",
"first_shots" = "x1st",
"second_shots" = "x2nd",
"third_shots" = "x3rd",
"overtime_shots" = "ot",
"total_shots" = "t")
shot
ncol(shot)
df
df <- df %>%
clean_names() %>%
pivot_longer(cols = 2:3) %>%
pivot_wider(names_from = team_stats) %>%
clean_names() %>%
separate(power_plays,
into = c("successful_power_play", "power_play_opportunities"),
sep = " / ") %>%
mutate_at(vars(successful_power_play,
power_play_opportunities,
power_play_percent,
penalty_minutes,
faceoff_percent,
blocked_opponent_shots,
takeaways,
giveaways), as.numeric) %>%
rename("team" = "name")
s <- shot %>%
left_join(score, by = c("team")) %>%
mutate(team = tolower(team))
df <- df %>%
left_join(s, by = c("team"))
score
score <- score %>%
clean_names() %>%
rename("team" = "scoring",
"first_scoring" = "x1st",
"second_scoring" = "x2nd",
"third_scoring" = "x3rd",
"overtime_scoring" = "ot",
"shootout_scoring" = "so",
"total_scoring" = "t")
shot <- shot %>%
clean_names() %>%
rename("team" = "shots",
"first_shots" = "x1st",
"second_shots" = "x2nd",
"third_shots" = "x3rd",
"overtime_shots" = "ot",
"total_shots" = "t")
shot
df <- df %>%
clean_names() %>%
pivot_longer(cols = 2:3) %>%
pivot_wider(names_from = team_stats) %>%
clean_names() %>%
separate(power_plays,
into = c("successful_power_play", "power_play_opportunities"),
sep = " / ") %>%
mutate_at(vars(successful_power_play,
power_play_opportunities,
power_play_percent,
penalty_minutes,
faceoff_percent,
blocked_opponent_shots,
takeaways,
giveaways), as.numeric) %>%
rename("team" = "name")
s <- shot %>%
left_join(score, by = c("team")) %>%
mutate(team = tolower(team))
df <- df %>%
left_join(s, by = c("team"))
df
str(df)
boxscore <- data.frame(
team = character(),
successful_power_play = numeric(),
power_play_opportunities = numeric(),
power_play_percent = numeric(),
penalty_minutes = numeric(),
faceoff_percent = numeric(),
blocked_opponent_shots = numeric(),
takeaways = numeric(),
giveaways = numeric(),
first_shots = integer(),
second_shots = integer(),
third_shots = integer(),
overtime_shots = integer(),
total_shots = integer(),
first_scoring = integer(),
second_scoring = integer(),
third_scoring = integer(),
overtime_scoring = integer(),
shootout_scoring = character(),
total_scoring = integer()
)
View(boxscore)
str(boxscore)
df <- bind_rows(df, boxscore)
str(df)
View(df)
df <- df %>%
mutate(winner = ifelse(total_scoring == max(total_scoring, na.rm = TRUE),
"Yes", "No"))
ncol(score)
score
ncol(shot)
shot
source('R/pbp_functions.R')
rg_box <- load_boxscore(game_id = 268078)
View(rg_box)
setdiff(colnames(boxscore), colnames(df))
setdiff(colnames(df), colnames(boxscore))
rm(list = ls())
rg_box <- load_boxscore(game_id = 268078)
source('R/pbp_functions.R')
a <- Sys.time()
rg <- load_pbp(game_id = 268078)
rg_messy <- load_pbp(game_id = 268078, format = "messy")
rg_box <- load_boxscore(game_id = 268078)
ot <- load_pbp(game_id = 268116)
ot2 <- load_pbp(game_id = 268116, format = "messy")
ot_box <- load_boxscore(game_id = 268116)
so <- load_pbp(game_id = 268123)
so2 <- load_pbp(game_id = 268123, format = "m")
so_box <- load_boxscore(game_id = 268123)
Sys.time() - a
str(so2$game_id)
source('R/pbp_functions.R')
a <- Sys.time()
rg <- load_pbp(game_id = 268078)
rg_messy <- load_pbp(game_id = 268078, format = "messy")
rg_box <- load_boxscore(game_id = 268078)
ot <- load_pbp(game_id = 268116)
ot2 <- load_pbp(game_id = 268116, format = "messy")
ot_box <- load_boxscore(game_id = 268116)
so <- load_pbp(game_id = 268123)
so2 <- load_pbp(game_id = 268123, format = "m")
so_box <- load_boxscore(game_id = 268123)
Sys.time() - a
lst <- list(so, so_box)
lst
load_game <- function(game_id = 268078) {
box <- load_boxscore(game_id = game_id)
pbp <- load_pbp(game_id = game_id)
game <- list(box, pbp)
return(game)
}
load_game(game_id = 268078)
